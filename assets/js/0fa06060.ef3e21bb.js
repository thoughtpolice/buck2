"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[7778],{3905:(e,a,n)=>{n.r(a),n.d(a,{MDXContext:()=>d,MDXProvider:()=>c,mdx:()=>b,useMDXComponents:()=>p,withMDXComponents:()=>u});var t=n(67294);function r(e,a,n){return a in e?Object.defineProperty(e,a,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[a]=n,e}function i(){return i=Object.assign||function(e){for(var a=1;a<arguments.length;a++){var n=arguments[a];for(var t in n)Object.prototype.hasOwnProperty.call(n,t)&&(e[t]=n[t])}return e},i.apply(this,arguments)}function l(e,a){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);a&&(t=t.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),n.push.apply(n,t)}return n}function o(e){for(var a=1;a<arguments.length;a++){var n=null!=arguments[a]?arguments[a]:{};a%2?l(Object(n),!0).forEach((function(a){r(e,a,n[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(n,a))}))}return e}function s(e,a){if(null==e)return{};var n,t,r=function(e,a){if(null==e)return{};var n,t,r={},i=Object.keys(e);for(t=0;t<i.length;t++)n=i[t],a.indexOf(n)>=0||(r[n]=e[n]);return r}(e,a);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(t=0;t<i.length;t++)n=i[t],a.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var d=t.createContext({}),u=function(e){return function(a){var n=p(a.components);return t.createElement(e,i({},a,{components:n}))}},p=function(e){var a=t.useContext(d),n=a;return e&&(n="function"==typeof e?e(a):o(o({},a),e)),n},c=function(e){var a=p(e.components);return t.createElement(d.Provider,{value:a},e.children)},m="mdxType",h={inlineCode:"code",wrapper:function(e){var a=e.children;return t.createElement(t.Fragment,{},a)}},f=t.forwardRef((function(e,a){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),u=p(n),c=r,m=u["".concat(l,".").concat(c)]||u[c]||h[c]||i;return n?t.createElement(m,o(o({ref:a},d),{},{components:n})):t.createElement(m,o({ref:a},d))}));function b(e,a){var n=arguments,r=a&&a.mdxType;if("string"==typeof e||r){var i=n.length,l=new Array(i);l[0]=f;var o={};for(var s in a)hasOwnProperty.call(a,s)&&(o[s]=a[s]);o.originalType=e,o[m]="string"==typeof e?e:r,l[1]=o;for(var d=2;d<i;d++)l[d]=n[d];return t.createElement.apply(null,l)}return t.createElement.apply(null,n)}f.displayName="MDXCreateElement"},29988:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>s,contentTitle:()=>l,default:()=>p,frontMatter:()=>i,metadata:()=>o,toc:()=>d});var t=n(87462),r=(n(67294),n(3905));const i={id:"build_rule",title:"Build Rule"},l="Build Rule",o={unversionedId:"concepts/build_rule",id:"concepts/build_rule",title:"Build Rule",description:"A build rule is a procedure for producing output files from a set of input",source:"@site/../docs/concepts/build_rule.md",sourceDirName:"concepts",slug:"/concepts/build_rule",permalink:"/docs/concepts/build_rule",draft:!1,tags:[],version:"current",frontMatter:{id:"build_rule",title:"Build Rule"},sidebar:"mainSidebar",previous:{title:"Concept Map",permalink:"/docs/concepts/concept_map"},next:{title:"Build File",permalink:"/docs/concepts/build_file"}},s={},d=[{value:"Buck2&#39;s collection of build rules",id:"buck2s-collection-of-build-rules",level:2},{value:"Source files as inputs to build rules",id:"source-files-as-inputs-to-build-rules",level:2},{value:"Package boundaries and access to source files",id:"package-boundaries-and-access-to-source-files",level:3},{value:"Symlinks: Use with caution if at all",id:"symlinks-use-with-caution-if-at-all",level:5},{value:"Dependencies: Output from one rule as input to another rule",id:"dependencies-output-from-one-rule-as-input-to-another-rule",level:2},{value:"Required dependencies are always built first",id:"required-dependencies-are-always-built-first",level:3},{value:"Visibility",id:"visibility",level:3},{value:"Dependencies define a graph",id:"dependencies-define-a-graph",level:3},{value:"How to handle special cases: genrules and macros",id:"how-to-handle-special-cases-genrules-and-macros",level:2},{value:"Multiple output files with genrules",id:"multiple-output-files-with-genrules",level:3},{value:"Macros",id:"macros",level:3},{value:"String parameter macros",id:"string-parameter-macros",level:2}],u={toc:d};function p(e){let{components:a,...n}=e;return(0,r.mdx)("wrapper",(0,t.Z)({},u,n,{components:a,mdxType:"MDXLayout"}),(0,r.mdx)("h1",{id:"build-rule"},"Build Rule"),(0,r.mdx)("p",null,"A ",(0,r.mdx)("em",{parentName:"p"},"build rule")," is a procedure for producing output files from a set of input\nfiles in the context of a specified build configuration. Build rules are\nspecified in ",(0,r.mdx)("a",{parentName:"p",href:"/docs/concepts/build_file"},"build file"),"s\u2014typically named BUCK. ",(0,r.mdx)("strong",{parentName:"p"},"Note:")," A\nbuild rule must explicitly specify, in its arguments, all of its required inputs\nin order for Buck2 to be able to build the rule's output in a way that is\ndeterministic and reproducible."),(0,r.mdx)("h2",{id:"buck2s-collection-of-build-rules"},"Buck2's collection of build rules"),(0,r.mdx)("p",null,"Buck2 comes with a collection of built-in build rules for many common build\nprocedures. For example, compiling Java code against the Android SDK is a common\nprocedure, so Buck2 provides the build rule\n",(0,r.mdx)("a",{parentName:"p",href:"../../prelude/globals#android_library"},(0,r.mdx)("inlineCode",{parentName:"a"},"android_library"))," to do that.\nSimilarly, the final product of most Android development is an APK, so you can\nuse the build rule ",(0,r.mdx)("a",{parentName:"p",href:"../../prelude/globals#android_binary"},(0,r.mdx)("inlineCode",{parentName:"a"},"android_binary"))," to\ncreate an APK."),(0,r.mdx)("h2",{id:"source-files-as-inputs-to-build-rules"},"Source files as inputs to build rules"),(0,r.mdx)("p",null,"Most build rules specify source files as inputs. For example, a\n",(0,r.mdx)("a",{parentName:"p",href:"../../prelude/globals#cxx_library"},(0,r.mdx)("inlineCode",{parentName:"a"},"cxx_library"))," rule would specify ",(0,r.mdx)("inlineCode",{parentName:"p"},".cpp"),"\nfiles as inputs. To support specifying these files, a ",(0,r.mdx)("inlineCode",{parentName:"p"},"cxx_library")," rule\nprovides the ",(0,r.mdx)("inlineCode",{parentName:"p"},"srcs")," argument. Some languages, such as C++, use header files as\nwell. To specify these, ",(0,r.mdx)("inlineCode",{parentName:"p"},"cxx_library")," provides a ",(0,r.mdx)("inlineCode",{parentName:"p"},"headers")," argument. In addition\nto ",(0,r.mdx)("inlineCode",{parentName:"p"},"srcs")," and ",(0,r.mdx)("inlineCode",{parentName:"p"},"headers"),", some rules provide variants of these arguments, such as\n",(0,r.mdx)("inlineCode",{parentName:"p"},"platform_srcs")," and ",(0,r.mdx)("inlineCode",{parentName:"p"},"platform_headers"),". These arguments support groups of source\nfiles that should be used as inputs only when building for specific platforms."),(0,r.mdx)("h3",{id:"package-boundaries-and-access-to-source-files"},"Package boundaries and access to source files"),(0,r.mdx)("p",null,"In Buck2, a BUCK file defines a ",(0,r.mdx)("em",{parentName:"p"},"package"),", which corresponds ",(0,r.mdx)("em",{parentName:"p"},"roughly")," to the\ndirectory that contains the BUCK file and those subdirectories that do not\nthemselves contain BUCK files. (To learn more, see the\n",(0,r.mdx)("a",{parentName:"p",href:"/docs/concepts/key_concepts"},"Key Concepts")," topic.) A rule in a BUCK file cannot specify a\nsource file as an input unless that source file is in that BUCK file's package.\nAn exception to this restriction exists for header files, but only if a rule in\nthe package that contains the header file ",(0,r.mdx)("em",{parentName:"p"},"exports")," that header file using the\n",(0,r.mdx)("inlineCode",{parentName:"p"},"exported_headers")," argument. For more details, see the description for\n",(0,r.mdx)("inlineCode",{parentName:"p"},"exported_headers")," in, for example, the\n",(0,r.mdx)("a",{parentName:"p",href:"../../prelude/globals#cxx_library"},(0,r.mdx)("inlineCode",{parentName:"a"},"cxx_library"))," topic. More commonly though,\nthe package for a BUCK file contains all the source files required for the rules\ndefined in that BUCK file. Functionality in source files from other packages is\nmade available through the artifacts produced by the rules in the BUCK files for\nthose packages. For example, a ",(0,r.mdx)("a",{parentName:"p",href:"../../prelude/globals/#cxx_binary"},(0,r.mdx)("inlineCode",{parentName:"a"},"cxx_binary")),"\nmight use the functionality in a ",(0,r.mdx)("inlineCode",{parentName:"p"},"cxx_library")," that is defined in another\npackage. To access that functionality, the ",(0,r.mdx)("inlineCode",{parentName:"p"},"cxx_binary")," would take that\n",(0,r.mdx)("inlineCode",{parentName:"p"},"cxx_library")," as a ",(0,r.mdx)("em",{parentName:"p"},"dependency"),"."),(0,r.mdx)("h5",{id:"symlinks-use-with-caution-if-at-all"},"Symlinks: Use with caution if at all"),(0,r.mdx)("p",null,"We recommend that you do ",(0,r.mdx)("em",{parentName:"p"},"not")," use symlinks\u2014either absolute or relative\u2014to\nspecify input files to build rules. Although using symlinks in this context does\nsometimes work, it can lead to unexpected behavior and errors."),(0,r.mdx)("h2",{id:"dependencies-output-from-one-rule-as-input-to-another-rule"},"Dependencies: Output from one rule as input to another rule"),(0,r.mdx)("p",null,"A build rule can use the output from another build rule as one of its inputs by\nspecifying that rule as a ",(0,r.mdx)("em",{parentName:"p"},"dependency"),". Typically, a build rule specifies its\ndependencies as a list of ",(0,r.mdx)("a",{parentName:"p",href:"/docs/concepts/build_target"},"build target"),"s in its ",(0,r.mdx)("inlineCode",{parentName:"p"},"deps"),"\nargument. However, the rule can also specify dependencies\u2014as build targets\u2014in\nother arguments, such as ",(0,r.mdx)("inlineCode",{parentName:"p"},"srcs"),". ",(0,r.mdx)("strong",{parentName:"p"},"Example:")," The output of a\n",(0,r.mdx)("a",{parentName:"p",href:"../../prelude/globals/#java_library"},(0,r.mdx)("inlineCode",{parentName:"a"},"java_library"))," rule is a JAR file. If a\n",(0,r.mdx)("inlineCode",{parentName:"p"},"java_library")," rule specifies another ",(0,r.mdx)("inlineCode",{parentName:"p"},"java_library")," rule as a dependency, the\nJAR file produced by the specified rule is added to the classpath for the\n",(0,r.mdx)("inlineCode",{parentName:"p"},"java_library")," that depends on it. ",(0,r.mdx)("strong",{parentName:"p"},"Example:")," If a\n",(0,r.mdx)("a",{parentName:"p",href:"../../prelude/globals/#java_binary"},(0,r.mdx)("inlineCode",{parentName:"a"},"java_binary"))," rule specifies a\n",(0,r.mdx)("inlineCode",{parentName:"p"},"java_library")," rule as a dependency, the JAR file for the specified\n",(0,r.mdx)("inlineCode",{parentName:"p"},"java_library")," is available on the classpath for the ",(0,r.mdx)("inlineCode",{parentName:"p"},"java_binary"),". In addition,\nin the case of ",(0,r.mdx)("inlineCode",{parentName:"p"},"java_binary"),", the JAR files for any dependencies of the\n",(0,r.mdx)("inlineCode",{parentName:"p"},"java_library")," rule ",(0,r.mdx)("em",{parentName:"p"},"are also")," made available to the ",(0,r.mdx)("inlineCode",{parentName:"p"},"java_binary")," rule\u2014and if\nthose dependencies have dependencies of their own, they are added as well. This\nexhaustive cascade of dependencies is referred to as the rule's ",(0,r.mdx)("em",{parentName:"p"},"transitive\nclosure"),"."),(0,r.mdx)("h3",{id:"required-dependencies-are-always-built-first"},"Required dependencies are always built first"),(0,r.mdx)("p",null,"Buck2 guarantees that any dependencies that a rule lists that are required in\norder to build that rule are built successfully ",(0,r.mdx)("em",{parentName:"p"},"before")," Buck2 builds the rule\nitself. Note though that there can be special cases\u2014such as\n",(0,r.mdx)("a",{parentName:"p",href:"../../prelude/globals/#apple_bundle"},(0,r.mdx)("inlineCode",{parentName:"a"},"apple_bundle")),"\u2014where a rule's listed\ndependencies do not actually need to be built before the rule."),(0,r.mdx)("h3",{id:"visibility"},"Visibility"),(0,r.mdx)("p",null,"In order for a build rule to take a dependency on another build rule, the build\nrule on which the dependency is taken must be ",(0,r.mdx)("em",{parentName:"p"},"visible")," to the build rule taking\nthe dependency. A build rule's ",(0,r.mdx)("inlineCode",{parentName:"p"},"visibility")," argument is a list of\n",(0,r.mdx)("a",{parentName:"p",href:"/docs/concepts/target_pattern"},"build target pattern"),"s that specify the rules that can take\nthat rule as a dependency. For more information about the concept of visibility\nin Buck2, see the ",(0,r.mdx)("a",{parentName:"p",href:"/docs/concepts/visibility"},"Visibility")," topic."),(0,r.mdx)("h3",{id:"dependencies-define-a-graph"},"Dependencies define a graph"),(0,r.mdx)("p",null,"Build rules and their dependencies define a directed acyclic graph (DAG). Buck2\nrequires this graph to be acyclic to make it possible to build independent\nsubgraphs in parallel."),(0,r.mdx)("h2",{id:"how-to-handle-special-cases-genrules-and-macros"},"How to handle special cases: genrules and macros"),(0,r.mdx)("p",null,'Although Buck2 provides a rich set of built-in build rules for developers, it is\nnot able to address all possible needs. As an "escape hatch," Buck2 provides a\ncategory of generic build rules called ',(0,r.mdx)("em",{parentName:"p"},"genrules"),". With genrules, you can\nperform arbitrary operations using shell scripts. The genrules supported by\nBuck2 are:"),(0,r.mdx)("ul",null,(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("a",{parentName:"li",href:"../../prelude/globals/#genrule"},(0,r.mdx)("inlineCode",{parentName:"a"},"genrule"))),(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("a",{parentName:"li",href:"../../prelude/globals/#apk_genrule"},(0,r.mdx)("inlineCode",{parentName:"a"},"apk_genrule"))),(0,r.mdx)("li",{parentName:"ul"},(0,r.mdx)("a",{parentName:"li",href:"../../prelude/globals/#cxx_genrule"},(0,r.mdx)("inlineCode",{parentName:"a"},"cxx_genrule")))),(0,r.mdx)("h3",{id:"multiple-output-files-with-genrules"},"Multiple output files with genrules"),(0,r.mdx)("p",null,"In most cases, a build rule produces exactly one output file. However, with\ngenrules, you can specify an output ",(0,r.mdx)("em",{parentName:"p"},"directory")," and write arbitrary files to\nthat directory."),(0,r.mdx)("h3",{id:"macros"},"Macros"),(0,r.mdx)("p",null,"Finally, note that you can define functions that generate build rules. In\ngeneral, this should not be something that you need to do, but taking advantage\nof this option might help you add needed functionality to Buck2's without\nediting its source code."),(0,r.mdx)("h2",{id:"string-parameter-macros"},"String parameter macros"),(0,r.mdx)("p",null,"It is also possible to expand references to other rules within the ",(0,r.mdx)("inlineCode",{parentName:"p"},"cmd"),", using\nbuiltin ",(0,r.mdx)("inlineCode",{parentName:"p"},"string parameter macros"),". All build rules expanded in the command are\nautomatically considered to be dependencies of the ",(0,r.mdx)("inlineCode",{parentName:"p"},"genrule()"),"."),(0,r.mdx)("p",null,"Note that the paths returned by these macros are ",(0,r.mdx)("em",{parentName:"p"},"relative")," paths. Using\nrelative paths ensures that your builds are ",(0,r.mdx)("em",{parentName:"p"},"hermetic"),", that is, they are\nreproducible across different machine environments."),(0,r.mdx)("p",null,(0,r.mdx)("inlineCode",{parentName:"p"},"$(classpath //path/to:target)")),(0,r.mdx)("p",null,"Expands to the transitive classpath of the specified build rule, provided that\nthe rule has a Java classpath. If the rule does not have (or contribute to) a\nclasspath, then an exception is thrown and the build breaks."),(0,r.mdx)("p",null,(0,r.mdx)("inlineCode",{parentName:"p"},"$(exe //path/to:target)")),(0,r.mdx)("p",null,"Expands a build rule that results in an executable to the commands necessary to\nrun that executable. For example, a ",(0,r.mdx)("inlineCode",{parentName:"p"},"java_binary()")," might expand to a call to\n",(0,r.mdx)("inlineCode",{parentName:"p"},"java -jar path/to/target.jar")," . Files that are executable (perhaps generated by\na ",(0,r.mdx)("inlineCode",{parentName:"p"},"genrule()"),") are also expanded. If the build rule does not generate an\nexecutable output, then an exception is thrown and the build breaks."),(0,r.mdx)("p",null,"If the ",(0,r.mdx)("inlineCode",{parentName:"p"},"$(exe my_dependency)")," dependency should actually be built with the\ntarget platform, use ",(0,r.mdx)("inlineCode",{parentName:"p"},"$(exe_target my_dependency)")," instead, which will stick to\nthe same platform as the target."),(0,r.mdx)("p",null,(0,r.mdx)("inlineCode",{parentName:"p"},"$(location //path/to:target)")),(0,r.mdx)("p",null,"Expands to the location of the output of the specified build rule. This means\nthat you can refer to the output without needing to be aware of how Buck is\nstoring data on the disk mid-build."),(0,r.mdx)("pre",null,(0,r.mdx)("code",{parentName:"pre"},"")))}p.isMDXComponent=!0}}]);